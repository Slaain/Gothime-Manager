<template>
    
  <div class="max-w-[720px] mx-auto">

    <div class="relative flex flex-col w-full h-full bg-white shadow-md text-slate-700 rounded-xl bg-clip-border">
      <div class="relative mx-4 mt-4 overflow-hidden bg-white rounded-none text-slate-700 bg-clip-border">
        <div class="flex items-center justify-between">
          <div>
              <h3 class="text-lg font-semibold text-slate-800">Employees List</h3>
            <p class="text-slate-500">Review each person before edit</p>
          </div>
          <div class="flex flex-col gap-2 shrink-0 sm:flex-row">
            <button
              @click="openUserModal"
              class="flex select-none items-center gap-2 rounded bg-slate-800 py-2.5 px-4 text-xs font-semibold text-white shadow-md shadow-slate-900/10 transition-all hover:shadow-lg hover:shadow-slate-900/20 focus:opacity-[0.85] focus:shadow-none active:opacity-[0.85] active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none"
              type="button"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
                aria-hidden="true"
                stroke-width="2"
                class="w-4 h-4"
              >
                <path
                  d="M6.25 6.375a4.125 4.125 0 118.25 0 4.125 4.125 0 01-8.25 0zM3.25 19.125a7.125 7.125 0 0114.25 0v.003l-.001.119a.75.75 0 01-.363.63 13.067 13.067 0 01-6.761 1.873c-2.472 0-4.786-.684-6.76-1.873a.75.75 0 01-.364-.63l-.001-.122zM19.75 7.5a.75.75 0 00-1.5 0v2.25H16a.75.75 0 000 1.5h2.25v2.25a.75.75 0 001.5 0v-2.25H22a.75.75 0 000-1.5h-2.25V7.5z"
                ></path>
              </svg>
              Add member
            </button>
          </div>
        </div>
      </div>

<div v-if="showCreateUserModal" id="default-modal" tabindex="-1" aria-hidden="true" class="fixed inset-0 z-50 flex items-center justify-center w-full h-full overflow-y-auto bg-gray-800 bg-opacity-50">
      <div class="w-1/2 px-8 py-4 bg-white ">
          <p class="text-xl font-extrabold text-zinc-950">New User</p>
          <label class="mb-3 flex px-2.5 font-bold leading-none text-zinc-950">
            User's Name
            <p class="ml-1 mt-[1px] text-sm font-medium leading-none text-zinc-500">(30 characters maximum)</p>
          </label>
          <input
            v-model="newUser.username"
            placeholder="Please enter your full name"
            class="flex items-center justify-center w-full h-full px-4 py-4 mb-2 transition-all duration-200 bg-transparent border-2 border-gray-400 rounded-lg shadow-sm outline-none text-zinc-950 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            type="text"
          />
          <label class="mb-3 flex px-2.5 font-bold leading-none text-zinc-950">User's Email</label>
          <input
            v-model="newUser.email"
            placeholder="Please enter your email"
            class="flex items-center justify-center w-full h-full px-4 py-4 mb-2 transition-all duration-200 bg-transparent border-2 border-gray-400 rounded-lg shadow-sm outline-none text-zinc-950 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            type="text"
          />
          <p class="h-6 text-red-600">{{error}}</p>
          <button
            @click="createUser"
            class="w-full py-2 mt-4 text-white transition-all bg-blue-500 rounded-lg hover:bg-blue-600"
          >
            Create User
          </button>
          <button
            @click="closeUserModal"
            class="w-full py-2 mt-2 text-white transition-all bg-red-500 rounded-lg hover:bg-red-600"
          >
            Cancel
          </button>
        </div>
    </div>

    <div v-if="showDeleteUserModal" id="default-modal" tabindex="-1" aria-hidden="true" class="fixed inset-0 z-50 flex items-center justify-center w-full h-full overflow-y-auto bg-gray-800 bg-opacity-50">
      <div class="w-1/2 px-8 py-4 bg-white ">
          <p class="text-xl font-extrabold text-zinc-950">Delete User</p>
          <p>Are you sure you want to delete this user?</p>
          <p class="h-6 text-red-600">{{error}}</p>
          <button
            @click="createUser"
            class="w-full py-2 mt-4 text-white transition-all bg-blue-500 rounded-lg hover:bg-blue-600"
          >
            Create User
          </button>
          <button
            @click="closeUserModal"
            class="w-full py-2 mt-2 text-white transition-all bg-red-500 rounded-lg hover:bg-red-600"
          >
            Cancel
          </button>
        </div>
    </div>

    
    
      

      <div class="p-0 overflow-scroll">
        <table class="w-full mt-4 text-left table-auto min-w-max">
          <thead>
            <tr>
              <th class="p-4 transition-colors cursor-pointer border-y border-slate-200 bg-slate-50 hover:bg-slate-100">
                <p class="flex items-center justify-between gap-2 font-sans text-sm font-normal leading-none text-slate-500">Member</p>
              </th>
              <th class="p-4 transition-colors cursor-pointer border-y border-slate-200 bg-slate-50 hover:bg-slate-100">
                <p class="flex items-center justify-between gap-2 font-sans text-sm font-normal leading-none text-slate-500">Status</p>
              </th>
              <th class="p-4 transition-colors cursor-pointer border-y border-slate-200 bg-slate-50 hover:bg-slate-100"></th>
              <th class="p-4 transition-colors cursor-pointer border-y border-slate-200 bg-slate-50 hover:bg-slate-100"></th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(employee, index) in employees" :key="index">
              <td class="p-4 border-b border-slate-200">
                <div class="flex items-center gap-3">
                  <div class="flex flex-col">
                    <p class="text-sm font-semibold text-slate-700">{{ employee.username }}</p>
                    <p class="text-sm text-slate-500">{{ employee.email }}</p>
                  </div>
                </div>
              </td>
              <td class="p-4 border-b border-slate-200">
                <p class="text-sm text-slate-500">{{ employee.status || 'N/A' }}</p>
              </td>
              <td class="p-4 border-b border-slate-200">
                <button
                  @click.stop="editEmployee(employee.id)"
                  class="text-sm text-blue-600 hover:underline"
                >
                  Edit
                </button>
              </td>
              <td class="p-4 border-b border-slate-200">
                <button
                  @click.stop="openUserDeleteModal"
                  class="text-sm text-red-600 hover:underline"
                >
                  Delete
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="flex items-center justify-between p-3">
        <p class="block text-sm text-slate-500">Page {{ currentPage }} of {{ totalPages }}</p>
        <div class="flex gap-1">
          <button
            class="rounded border border-slate-300 py-2.5 px-3 text-center text-xs font-semibold text-slate-600 transition-all hover:opacity-75 focus:ring focus:ring-slate-300 active:opacity-[0.85] disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none"
            type="button"
            @click="previousPage"
            :disabled="currentPage === 1"
          >
            Previous
          </button>
          <button
            class="rounded border border-slate-300 py-2.5 px-3 text-center text-xs font-semibold text-slate-600 transition-all hover:opacity-75 focus:ring focus:ring-slate-300 active:opacity-[0.85] disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none"
            type="button"
            @click="nextPage"
            :disabled="currentPage === totalPages"
          >
            Next
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import userService from '../userService';
import { useToast } from "vue-toastification";
import CreateUserModal from './modal/CreateUserModal.vue';

// Propriété réactive pour contrôler la visibilité de la modale

// Méthode pour ouvrir la modale


export default {


  setup (){
    const toast = useToast();
    return { toast };
  },
  name: 'EmployeeList',
  data() {
    return {
      employees: [],
      currentPage: 1,
      limit: 5,
      totalPages: 10,
      showCreateUserModal: false, // Ajout de la variable pour le formulaire
      newUser: {
        username: '',
        email: '',
      },
      error: '',
      showCreateUserModal: false,
      showDeleteUserModal: false,
    };
  },
  methods: {
    
    openUserModal() {
      this.showCreateUserModal = true;
    },

    closeUserModal() {
      this.newUser.username = '';
      this.newUser.email = '';
      this.error = '';
      this.showCreateUserModal = false;
      
    },

    openUserDeleteModal(){
      this.showDeleteUserModal = true;
    },

    closeUserDeleteModal(){
      this.showDeleteUserModal = false;
    },


    // params in english
        showSuccessToast(message = "Successful operation" ) {
      this.toast.success(message);
          console.log("this.toast : ", this.toast);

    },
    // params in english
    showErrorToast(message = "An error occurred") {
      this.toast.error(message);
    },
    createUser() {
    const userData = {
      user: {
        username: this.newUser.username,
        email: this.newUser.email,
      }
    };
    console.log("this.$toast : ", this.$toast);

    if(userData.user.username === '' || userData.user.email === '') {
      // alert("Please fill in all fields.");
      // this.showErrorToast("Please fill in all fields.");
      this.error = "Please fill in all fields.";
      return;
    }

    
    console.log('Creating user:', userData);
    
    
    userService.createUser(userData)
      .then((response) => {
        this.employees.push({ ...userData.user, status: 'Active' });
        this.newUser.username = '';
        this.newUser.email = '';
        this.error = '';
        this.showCreateUserModal = false;
        console.log("User created successfully:", response);

        if(response.result){
          // succes toaster
          this.showSuccessToast(response.message);

        } else {
          // error toaster
          // this.showErrorToast(response.message);
          this.error = response.message;
        }
      })
      .catch(error => {
        console.error(`Error creating user: ${error.response.data.message}`, error);
        // this.toast.info(error.response.data.message)
        this.error = error.response.data.message;
        
        // alert("Une erreur s'est produite lors de la création de l'utilisateur.");
      });
  },

    editEmployee(id) {
      console.log(`Editing employee with ID: ${id}`);
      this.showAccountDetails(id);
    },
    showAccountDetails(employeeId) {
      this.$emit('show-account-details', employeeId);
    },
    fetchEmployees() {
      const offset = (this.currentPage - 1) * this.limit;
      console.log(`Fetching employees with limit ${this.limit} and offset ${offset}`);
      userService.getUsers(this.limit, offset)
        .then(data => {
          console.log('Employees data:', data);
          this.employees = data.data;
        })
        .catch(error => {
          console.error('Erreur lors de la récupération des employés:', error);
        });
    },
    nextPage() {
      console.log('Next page');
      if (this.currentPage < this.totalPages) {
        this.currentPage++; 
        this.fetchEmployees();
      }
    },
    previousPage() {
      console.log('Previous page');
      if (this.currentPage > 1) {
        this.currentPage--;
        this.fetchEmployees();
      }
    },
    confirmDelete(id) {
      if (confirm("Êtes-vous sûr de vouloir supprimer cet utilisateur ?")) {
        this.deleteEmployee(id);
      }
    },
    deleteEmployee(id) {
      console.log(`Deleting employee with ID: ${id}`);
      userService.deleteUser(id)
        .then(() => {
          this.fetchEmployees();
        })
        .catch(error => {
          console.error('Erreur lors de la suppression de l\'employé:', error);
        });
    },
  },
  mounted() {
    this.fetchEmployees();
  },
};
</script>
